<script>
$("#newVisit").click(function(e){
	var svnr = $("#svnr").text();
	var gebdat = $("#gebdat").text();
	var pid = $("#pid").val();
	patient = JSON.stringify({svnr : svnr, birthdate : gebdat, patid : pid});
	$.ajax({
		type: "POST",
		url: "visit/newVisit",
		dataType: "json",
		data: patient,
		contentType: "application/json;charset=UTF-8",
		success: function(data){
			if(data.msg=="success"){
				$.ajax({
					type: "POST",
					url: "patient/show",
					dataType: "json",
					contentType: "application/json; charset=utf-8",
					data : JSON.stringify({ svnr : svnr, birthdate : gebdat}),
					success: function (resp) {
						if(resp.msg=="success"){
							$("#content").html(resp.data);
						} else {
							$.alert({
							    title: 'Fehler',
							    content: "Ein unerwarteter Fehler ist aufgetreten!",
							    confirm: function(){}
							});
						}
					}
				});
			} else {
				$.alert({
			    	title: 'Fehler',
			    	content: data.msg,
			    	confirm: function(){}
				});
			}
		}
	});
});
$("#back").click(function(){
	$.ajax({
		type: "GET",
		url: "patient/show",
		dataType: "html",
		contentType: "text/html;charset=UTF-8",
		success: function (data) {
			$("#content").html(data);
		}
	});
});
$("#compareFoto").click(function(e){
	$.fancybox({
        'content' : $("#chooseFotos").html()
    });
});
var caseno = '';
$(".services").click(function(e){
	var id = $(this).parent().attr('id');
	$.fancybox({
        'content' :$("#"+id+" .serviceContainer").html(),
        onCleanup: function() { 
	    	$("#"+id+" .serviceContainer").html($("#fancybox-inner").html());    
        }
	});
    $("#"+id+" .serviceContainer").html("");
	caseno = '';
});

function refreshChecked(id){
	var selectedServices = ";";
	$('#serviceInnerWrapper_'+id+' input:checked').each(function() {
		selectedServices += $(this).val()+";";
	});
	$('#serviceInnerWrapper_'+id+' input[type=checkbox]').each(function(){
		if(selectedServices.indexOf(";"+$(this).val()+";")==-1){
			$(this).attr('checked', false);
		} else {
			$(this).attr('checked', true);
		}
	});
}

//$("div.serviceContainer input.saveServices").click(function(e){
function saveService(caseno){
	var selectedServices = "";
	$('#serviceInnerWrapper_'+caseno+' input:checked').each(function() {
		selectedServices += $(this).val()+";";
	});
	services = JSON.stringify({caseno : caseno, selectedServices : selectedServices});
	
	$.ajax({
		type: "POST",
		url: "service/newService",
		dataType: "json",
		contentType: "application/json; charset=utf-8",
		data : services,
		success: function (data) {
			var content = "";
			if(data.status=="success"){
				content="Erfolgreich gespeichert!";
			} else {
				content='Fehler beim verspeichern der Leistugen für den Patienten!<br />'+data.msg;
			}
			$.alert({
			    title: 'Leistungen Speichern',
			    content: content,
			    confirm: function(){
			    	refreshChecked(caseno);
			    	$.fancybox.close();
			    	caseno='';
			    }
			});
		}
	});
	
}

$(".showDiagnosis").click(function(e){
	var cont = '<div class="showDiagContainer"><h3 style="width:100%; text-align:center;">Diagnosen</h3>';
	$(this).parent().find("div.diagnoseContainer").each(function(e){
		cont+=$(this).html();
	});
	cont+='</div>';
	$.fancybox({
        'content' : cont
	});
});
$(".exportHonoranote").click(function(e){
	var caseno = $(this).parent().attr('id');
	var pid = $("#pid").val();
	$.ajax({
		type: "POST",
		url: "tools/exportPDF",
		beforeSend: function( xhr ) {
    		$("#dataContainer").fadeOut(function() {
				$("#menuBar").hide();
    			$("#ajaxLoader").fadeIn();
    		});	
  		},
		dataType: "json",
		contentType: "application/json;charset=UTF-8",
		data: JSON.stringify({ caseno  : caseno, pid : pid }),
		success: function (data) {
			var content = "";
			if(data.state=='success'){
				content = 'Honorarnote erfolgreich exportiert!';
			} else {
				content = 'Fehler: '+data.error;
			}
			$.alert({
			    title: 'Honorarexport!',
			    content: content,
			    confirm: function(){
			    	$("#ajaxLoader").fadeOut(function() {
				    	$("#dataContainer").fadeIn();
				    	$("#menuBar").fadeIn();
			    	});
			    }
			});
		}
	});
});
$(".importFoto").click(function(){
	var caseno = $(this).parent().attr('id');
	$.fancybox({
        'content' : $("#"+caseno+"_uploadContainer").show(),
        onCleanup: function() { 
        	$("#"+caseno).append($("#"+caseno+"_uploadContainer"));
			$("#"+caseno+"_uploadContainer").hide();
			$(".preview").html('');
        }
	});
});
$(".showFotos").click(function(){
	var caseno = $(this).parent().attr('id');
	resultEl = $("#"+caseno+"_showFotoContainer");
	actEl = $(this);
	$.ajax({
	    crossDomain: true,
	    type: "POST",
	    url: "foto/showF", 
	    contentType: "application/json",
	    dataType: "json",
	    data: JSON.stringify({caseno : caseno})
	}).done(function (data) {
		if(data.state=="success") {
			var anz = data.anz;
		    resultEl.html("<br />");
		    var j=0;	
		    for(j=0; j<anz; j++){
		    	resultEl.append('<img src="data:image/jpg;base64,' + data['pic_'+j] + '" style="width:300px;" />');
		    	resultEl.append('<br />');
		    }
		    $.fancybox({
		        'content' : '<div class="fotoContainer" style="display:block;">'+$(resultEl).html()+'</div>',
		        onCleanup: function() {}
			});
		} else if (data.state=="error"){
			$.alert({
			    title: 'Fotos!',
			    content: data.msg,
			    confirm: function(){}
			});
		}
	});
});
$('input[type=file]').change(function(e){
	var parId = $(this).parent().parent().attr('id');
	files=$(this).get(0).files;
	anz=0;
	for(i=0; i<files.length; i++){
		var oFReader = new FileReader();
        oFReader.readAsDataURL(files[i]);
        oFReader.onload = function (oFREvent) {
        	$("div#"+parId+" div.preview").append('<img src="'+oFREvent.target.result+'" name="preview_'+anz+'" style="width:150px;" /> ') ;
        	$("div#"+parId+" div.preview").append('<select id="kategorie_'+anz+'"><option value="sonstige">Sonstige</option><option value="zunge">Zunge</option><option value="portrait">Patientenportrait</option></select><br />');
        	anz++;
        };
	}
});

var oldLeft = '';
var oldRight = '';
function getSelectedPic(el){
	var id = $(el).find(":selected").val();
	var idSelect = $(el).attr('id');
	alert(id);
	if(id=='none') {
		if(idSelect=='left'){
			oldLeft='';
			$("#leftPic").html("");
		} else if(idSelect=='right'){
			oldRight='';
			$("#rightPic").html("");
		}
	} else {
		var x = $("#"+id);
		if(idSelect=='left'){
			$("#leftPic").html(x);
			alert($("#leftPic").html());
			oldLeft=el;
			$("#right").remove($(oldLeft).attr('id'));
		} else if(idSelect=='right'){
			$("#rightPic").html(x);
			oldRight=el;
			$("#left").remove($(oldRight).attr('id'));
		}
	}
}

function uploadFoto(caseno) {
	var file = $('#upload_'+caseno);
	var files = file[0].files;
	var formData = new FormData();
	formData.append('caseno', caseno);
	formData.append('anzPix', files.length);
	anz=0;
	for(i=0; i<files.length; i++){
		formData.append('file_'+anz, files[i]);
		formData.append('description_'+anz, $('#kategorie_'+anz+' option:selected').val());
		anz++;
	}
	$.ajax({
	  url : 'foto/upload',
	  type : 'POST',
	  data : formData,
	  cache : false,
	  contentType : false,
	  processData : false,
	  success : function(data) {
	    var state = data.state;
	    var msg = data.msg;
	    if(state=="success"){}else if(state=="error") {}
	    $.alert({
			title: 'Foto-Upload',
			content: msg,
			confirm: function(){
				$.fancybox.close();
				refreshPortrait();
			}
		});
	  },
	  error : function(jqXHR, textStatus, errorThrown) {
	    alert(textStatus);
	  }
	});
}

function getDiagForm(id){
		$.ajax({
			type: "GET",
			url: "diagnose/newDiagnose",
			dataType: "html",
			contentType: "text/html;charset=UTF-8",
			success: function (data) {
				$.fancybox({
			        'content' : data,
			        onCleanup: function() { 
						$("#actCaseno").val('');
			        }
				});
				$("#actCaseno").val(id);
			}
		});
}

function cancelUpload(caseno) {
	$.fancybox.close();
}

function IsNullOrEmpty(value)
{
    return (value == null || value === "");
}

function refreshPortrait(){
	pid = $("#pid").val();
	$.ajax({
		type: "POST",
		url: "foto/refreshPortrait",
		dataType: "html",
		contentType: "application/json",
	    dataType: "json",
	    data: JSON.stringify({pid : pid}),
		success: function (data) {
			if(data.state=="success"){
				if(!IsNullOrEmpty(data.pic)){
					$("#portrait").attr('src', 'data:image/jpg;base64,'+ data.pic +'');
				} 
			} else if(data.state="error"){
				$.alert({
				    title: 'Refresh Error',
				    content: data.msg,
				    confirm: function(){}
				});
			}
		}
	});
	
}

</script>
<div id="menuBar" style="width:90%; margin:auto; margin-top:20px;">
	<span class="link" id="back">Zur&uuml;ck</span> 
	<span class="link" id="newVisit">Neuer Besuch</span>
	<span class="link" id="compareFoto">Foto Abgleich</span>
</div>
<div id="ajaxLoader"><img src="pictures/ajax-loader.gif" /></div>
<div id="dataContainer">
	<div id="person">
		<div id="patientPortraiContainer">
		$portrait
		</div>
		<div id="persondataContainer">
			<div id="persondata">
				<h3>$patientsName</h3>
				<span class="headline">SVNR: </span><span id="svnr">$svnr</span><br />
				<span class="headline">Geburtsdatum: </span><span id="gebdat">$gebdat</span>
			</div>
			<div id="address">
				<h3>Adresse:</h3>
				<span class="headline">Stra&szlig;e: </span><span>$street</span><br />
				<span class="headline">PLZ: </span><span>$zip</span><br />
				<span class="headline">Ort: </span><span>$location</span><br />
				<span class="headline">Staat: </span><span>$country</span>
			</div>
			<div id="contact">
				<h3>Kontakt:</h3>
				<span class="headline">Telefon: </span><span>$telefon</span><br />
				<span class="headline">Email: </span><span>$email</span>
			</div>
		</div>
	</div>
	<div id="visitsContainer">
		<h3>Besuche</h3>
			$visits
	</div>
	<input type="hidden" id="pid" value="$pid" />
	<br style="clear:both;" />
	
	<div id="chooseFotos" style="display:none">
	    <label>Linkes Foto:</label><select id="left" onChange="javascript:getSelectedPic(this)"><option value="none">==Bitte wählen==</option>$foto_choose</select>
	    <label>Rechtes Foto:</label><select id="right"><option value="none">==Bitte wählen==</option>$foto_choose</select>
	    <div id="fotoShownContainer">
	    	<div id="leftPic"></div>
	    	<div id="rightPic"></div>
	    </div>
	</div>

	<div id="fotoHiddenContainer" style="display:none;">
		$fotos
	</div>
	
	
</div>
